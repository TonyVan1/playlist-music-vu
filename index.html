<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" integrity="sha512-YWzhKL2whUzgiheMoBFwW8CKV4qpHQAEuvilg9FAn5VJUDwKZZxkJNuGM4XkWuk94WCrrwslk8yWNGmY1EduTA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- <script src="./javascript/main.js"></script> -->
  <title>Music Player</title>
</head>
<body>
  <div id="wrapper">
    <div id="dashboard">
      <!-- Header -->
      <div id="header">
        <span>Now Playing:</span>
        <p class="name-wrap"></p>
      </div>
      <!-- CD -->
      <div id="cd">
        <div class="thumbnail"></div>
      </div>
    
      <!-- button -->
      <div id="control">
        <div class="btn btn-repeat">
          <i class="fas fa-redo"></i>
        </div>
        <div class="btn btn-prev">
          <i class="fas fa-step-backward"></i>
        </div>
        <div class="btn btn-pause-play">
          <i class="fas fa-pause icon-pause"></i>
          <i class="fas fa-play icon-play"></i>
        </div>
        <div class="btn btn-next">
          <i class="fas fa-step-backward"></i>
        </div>
        <div class="btn btn-random">
          <i class="fas fa-random"></i>
        </div>
      </div>
      <!-- Time -->
      <div id="time">
        <span class="currentTime">0:00</span>
        <input id="progress" class="progress" max="100" min="0" step="1" type="range" value="0">
        <span class="duration">0:00</span>
      </div>
      <!-- Volume -->
      <div id="volume">
        <div class="volume-min vl-btn">
          <i class="fas fa-volume-mute"></i>
        </div>
        <input id="volume-progress" class="progress" max="100" min="0" step="1" type="range" value="100">
        <div class="volume-max vl-btn">
          <i class="fas fa-volume-up"></i>
        </div>
      </div>
      <!-- audio playing -->
      <audio id="audio" src=""></audio>
    </div>
    <div id="playlist">
      <!-- song1 -->
      <!-- <div class="song active">
        <div class="thumb" style="background-image: url(./picture/image1.jpg); border-radius: 100%;"></div>
        <div class="body">
          <div class="title">Trốn Tìm1</div>
          <div class="author">Đen Vâu</div>
        </div>
        <div class="option">
          <i class="fas fa-random"></i>
        </div>
      </div> -->
    </div>
  </div>
<!-- script -->
  <script>
    $ = document.querySelector.bind(document);
    $$ = document.querySelectorAll.bind(document);

    const header = $('#header .name-wrap');
    const cd = $('#cd');
    const cdThumb = $('#cd .thumbnail');
    const audio = $('#audio');
    const togglePlay = $('.btn-pause-play');
    const progress = $('#progress');
    const volumeProgress = $('#volume-progress');
    const nextBtn = $('.btn-next');
    const prevBtn = $('.btn-prev');
    const randBtn = $('.btn-random');
    const repeatBtn = $('.btn-repeat');
    const playlist = $('#playlist');
    const timeNow = $('.currentTime');
    const duration = $('.duration');
    const maxVolume = $('.volume-max');
    const minVolume = $('.volume-min');

    // format time
    function formatTime(sec) {
      let min,newSec;
      min = Math.floor(sec / 60);
      newSec = sec - (min*60);
      if(newSec<10){
        return `${min}:0${newSec}`;
      }
      else{
        return `${min}:${newSec}`;
      }
    };

    const app = {
      currentIndex: 0,
      isPlaying: false,
      isRandom: false,
      isRepeat: false,
      songs: [
        {
          name: 'Bước Qua Nhau',
          singer: 'Vũ.',
          path: './music/buocquanhau.mp3',
          image: './picture/buocquanhau.jpg'
        },
        {
          name: 'Happy For You',
          singer: 'Vũ. ft. Lukas Graham',
          path: './music/happyforyou.mp3',
          image: './picture/happyforyou.jpg'
        },
        {
          name: 'Bước Qua Mùa Cô Đơn',
          singer: 'Vũ.',
          path: './music/buocquamuacodon.mp3',
          image: './picture/buocquamuacodon.jpg'
        },        
        {
          name: 'Một Giấc Mơ',
          singer: 'Vũ. ft. Kimmese',
          path: './music/motgiacmo.mp3',
          image: './picture/motgiacmo.jpg'
        },
        {
          name: 'Đã Từng Là',
          singer: 'Vũ.',
          path: './music/datungla.mp3',
          image: './picture/datungla.jpg'
        },
        {
          name: 'sau chia tay ta con gi',
          singer: 'Vũ.',
          path: './music/sauchiataytacongi.mp3',
          image: './picture/sauchiataytacongi.jpg'
        },
        {
          name: 'Mùa Hè Của Em',
          singer: 'Vũ.',
          path: './music/muahecuaem.mp3',
          image: './picture/muahecuaem.jpg'
        },
        {
          name: 'Hành Tinh Song Song',
          singer: 'Vũ.',
          path: './music/hanhtinhsongsong.mp3',
          image: './picture/hanhtinhsongsong.jpg'
        },
        {
          name: 'Chuyện Những Người Yêu Xa',
          singer: 'Vũ.',
          path: './music/chuyennhungnguoiyeuxa.mp3',
          image: './picture/chuyennhungnguoiyeuxa.jpg'
        },
        {
          name: 'Đợi',
          singer: 'Vũ.',
          path: './music/doi.mp3',
          image: './picture/doi.jpg'
        },  
        {
          name: 'Lạ Lùng',
          singer: 'Vũ.',
          path: './music/lalung.mp3',
          image: './picture/lalung.jpg'
        },
        {
          name: 'Mùa Mưa Ngâu Nằm Cạnh',
          singer: 'Vũ.',
          path: './music/muamuangaunamcanh.mp3',
          image: './picture/muamuangaunamcanh.jpg'
        },
        {
          name: 'Đông Kiếm Em',
          singer: 'Vũ.',
          path: './music/dongkiemem.mp3',
          image: './picture/dongkiemem.jpg'
        },
        {
          name: 'Phút Ban Đầu',
          singer: 'Vũ.',
          path: './music/phutbandau.mp3',
          image: './picture/phutbandau.jpg'
        },
        
      ],
      
      // print all playlist song
      render: function() {
        const htmls = this.songs.map((song,index) => {
          return `
          <div class="song ${index === this.currentIndex ? 'active' :''}" data-index="${index}">
            <div class="thumb" style="background-image: url(${song.image});"></div>
            <div class="body">
              <div class="title">${song.name}</div>
              <div class="author">${song.singer}</div>
            </div>
            <div class="option">
              <i class="fas fa-random"></i>
            </div>
          </div>
          `;
        });
        $('#playlist').innerHTML = htmls.join('');
      },
      
      // define Properties
      defineProperties: function() {
        Object.defineProperty(this, 'currentSong', {
          get: function() {
            return this.songs[this.currentIndex];
          }
        })
      },

      // loadcurrentsong
      loadCurrentSong: function() {
        header.textContent = this.currentSong.name + ' - ' + this.currentSong.singer;
        cdThumb.style.backgroundImage = `url(${this.currentSong.image})`;
        audio.src = this.currentSong.path;
      },

      // next song
      nextSong: function() {
      this.currentIndex++;
      if (this.currentIndex >= this.songs.length){
        this.currentIndex = 0;
      }
      this.loadCurrentSong();
      },
      // prev song
      prevSong: function() {
      if (this.currentIndex === 0){
        this.currentIndex = this.songs.length-1;
      }
      else{
        this.currentIndex--;
      }
      this.loadCurrentSong();
      },
      // random song
      playRandomSong: function() {
        let newIndex;
        do{
          newIndex = Math.floor(Math.random() * this.songs.length);
        }
        while(newIndex === this.currentIndex);
        this.currentIndex = newIndex;
        this.loadCurrentSong();
      },
      scrollToActiveSong: function() {
        setTimeout(function(){
          $('.song.active').scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
          });
        }
        ,300);
      },
      hangleEvent: function() {
        const _this =this;
        const cdWidth = cd.offsetWidth;
        
      // CD spin around when played
      const cdThumbAnimate = cdThumb.animate([
        { transform: 'rotate(360deg)'}
      ], {
        duration: 10000,
        iterations: Infinity
      });
      cdThumbAnimate.pause();

      // scroll top and hide CD thumbnail
        document.onscroll = function() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const newWidth = cdWidth - scrollTop;
          cd.style.width = newWidth>0 ? newWidth + 'px' : 0;
          cd.style.opacity = newWidth / cdWidth;
        };

      // Play when click pause and vice versa
      togglePlay.onclick = function() {
        if (_this.isPlaying) {
          audio.pause();
          cdThumbAnimate.pause();
        }
        else {
          audio.play();
          cdThumbAnimate.play();
        }
      };
      // When song is played
      audio.onplay = function() {
        togglePlay.classList.add('playing');
        _this.isPlaying = true;
      };
      // When song is paused
      audio.onpause = function() {
        togglePlay.classList.remove('playing');
        _this.isPlaying = false;
      };
      // When time of song has changed
      audio.ontimeupdate = function() {
        if (audio.duration){
          const progressPercent = Math.floor(audio.currentTime / audio.duration * 100);
          progress.value = progressPercent;
          // update time
          timeNow.innerHTML = formatTime(Math.floor(audio.currentTime));
          duration.innerHTML = formatTime(Math.floor(audio.duration));
        }
      }
      //When timeline is skip little time
      progress.onchange = function(e) {
        const seekTime = Math.floor(e.target.value / 100 *  audio.duration);
        audio.currentTime = seekTime;
        // update time
        timeNow.innerHTML = formatTime(seekTime);
        duration.innerHTML = formatTime(Math.floor(audio.duration));
      };
      // when adjust volume
      volumeProgress.onchange = function(e) {
        const newVolume = e.target.value/100;
        audio.volume = newVolume;
      };
      // click max volumn
      maxVolume.onclick = function() {
        audio.volume = 1;
        volumeProgress.value = 100;
      }
      // click min volumn(mute)
      minVolume.onclick = function() {
        audio.volume = 0;
        volumeProgress.value = 0;
      }

      // When next button is clicked
      nextBtn.onclick = function() {
        if (_this.isRandom == true){
          _this.playRandomSong();
        }
        else{
          _this.nextSong();
        }
        audio.play();
        _this.render();
        _this.scrollToActiveSong();
      };
      // When prev button is clicked
      prevBtn.onclick = function() {
        if (_this.isRandom == true){
          _this.playRandomSong();
        }
        else{
          _this.prevSong();
        }
        audio.play();
        _this.render();
        _this.scrollToActiveSong();
      };
      // on/off random button
      randBtn.onclick = function() {
        _this.isRandom = !_this.isRandom;
        randBtn.classList.toggle('active',_this.isRandom);
      };
      // on/off repeat button
      repeatBtn.onclick = function() {
        _this.isRepeat = !_this.isRepeat;
        repeatBtn.classList.toggle('active',_this.isRepeat);
      };

      // when song had ended
      audio.onended = function() {
        if (_this.isRepeat){
          audio.play();
        }
        else{
          nextBtn.click();
        }
      };

      // playlist on click
      playlist.onclick = function(e) {
        const songNode = e.target.closest('.song:not(.active)');
        if (songNode || e.target.closest('.option')
        ){
          // when click other song
          if (songNode) {
            const newIndex = Number(songNode.getAttribute('data-index'));
            _this.currentIndex = newIndex;
            _this.loadCurrentSong();
            _this.render();
            audio.play();
          }

          // when click option playlist
          // waiting update
        }
      };
      },
      
      // First Function Running
      start: function() {
      // define Properties
        this.defineProperties();

        //a lot of events
        this.hangleEvent();

        // load current song
        this.loadCurrentSong();

        // print all playlist song
        this.render();
      }
    };
    app.start();
  </script>
</body>
</html>